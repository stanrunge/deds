INSERT INTO
  dw.dbo.dim_course (COURSE_CODE, COURSE_DESCRIPTION)
SELECT
  COURSE_CODE,
  COURSE_DESCRIPTION
FROM
  deds. dbo.course;


INSERT INTO
  dw.dbo.dim_order_method (ORDER_METHOD_CODE, ORDER_METHOD_EN)
SELECT
  ORDER_METHOD_CODE,
  ORDER_METHOD_EN
FROM
  deds. dbo.order_method;


INSERT INTO
  dw.dbo.dim_product (
    PRODUCT_NUMBER,
    INTRODUCTION_YEAR,
    INTRODUCTION_WEEK,
    INTRODUCTION_WEEKDAY,
    INTRODUCTION_DAY,
    INTRODUCTION_GROUP,
    PRODUCT_TYPE_CODE,
    PRODUCTION_COST,
    MARGIN,
    PRODUCT_IMAGE,
    LANGUAGE,
    PRODUCT_NAME,
    DESCRIPTION
  )
SELECT
  PRODUCT_NUMBER,
  YEAR(CAST(CAST(INTRODUCTION_DATE AS VARCHAR(20)) AS DATE)) AS INTRODUCTION_YEAR,
  DATEPART(WEEK, CAST(CAST(INTRODUCTION_DATE AS VARCHAR(20)) AS DATE)) AS INTRODUCTION_WEEK,
  DATEPART(WEEKDAY, CAST(CAST(INTRODUCTION_DATE AS VARCHAR(20)) AS DATE)) AS INTRODUCTION_WEEKDAY,
  DAY(CAST(CAST(INTRODUCTION_DATE AS VARCHAR(20)) AS DATE)) AS INTRODUCTION_DAY,
  NULL AS INTRODUCTION_GROUP,
  PRODUCT_TYPE_CODE,
  PRODUCTION_COST,
  MARGIN,
  PRODUCT_IMAGE,
  LANGUAGE,
  PRODUCT_NAME,
  DESCRIPTION
FROM
  deds. dbo.product;


INSERT INTO
  dw.dbo.dim_retailer_contact (
    RETAILER_CONTACT_CODE,
    FIRST_NAME,
    LAST_NAME,
    JOB_POSITION_EN,
    EXTENSION,
    FAX,
    E_MAIL,
    GENDER
  )
SELECT
  RETAILER_CONTACT_CODE,
  FIRST_NAME,
  LAST_NAME,
  JOB_POSITION_EN,
  EXTENSION,
  FAX,
  E_MAIL,
  GENDER
FROM
  deds.dbo.retailer_contact;


INSERT INTO
  dw.dbo.dim_retailer_site (
    RETAILER_SITE_CODE,
    RETAILER_CODE,
    RETAILER_COMPANY_NAME,
    RETAILER_TYPE_CODE,
    RETAILER_TYPE_EN,
    RETAILER_CODEMR,
    RETAILER_HQ_ADDRESS1,
    RETAILER_HQ_ADDRESS2,
    RETAILER_HQ_CITY,
    RETAILER_HQ_REGION,
    RETAILER_HQ_POSTAL_ZONE,
    RETAILER_HQ_COUNTRY_NAME,
    RETAILER_HQ_COUNTRY_LANGUAGE,
    RETAILER_HQ_COUNTRY_CURRENCY_NAME,
    RETAILER_HQ_PHONE,
    RETAILER_HQ_SEGMENT_CODE,
    RETAILER_HQ_SEGMENT_LANGUAGE,
    RETAILER_HQ_SEGMENT_NAME,
    RETAILER_HQ_SEGMENT_DESCRIIPTION,
    ADDRESS_1,
    ADDRESS_2,
    ACTIVE_INDICATOR,
    COUNTRY_NAME,
    COUNTRY_LANGUAGE,
    COUNTRY_CURRENCY_NAME,
    POSTAL_ZONE,
    REGION,
    CITY
  )
SELECT
    rs.RETAILER_SITE_CODE,
    rs.RETAILER_CODE,
    retailer.COMPANY_NAME,
    retailer.RETAILER_TYPE_CODE,
    rt.RETAILER_TYPE_EN,
    retailer.RETAILER_CODEMR,
    hq.ADDRESS1,
    hq.ADDRESS2,
    hq.CITY,
    hq.REGION,
    NULL AS RETAILER_HQ_POSTAL_ZONE,
    hq_country.COUNTRY_EN,
    hq_country.LANGUAGE,
    hq_country.CURRENCY_NAME,
    hq.PHONE,
    hq.SEGMENT_CODE,
    rsm.LANGUAGE,
    rsm.SEGMENT_NAME,
    rsm.SEGMENT_DESCRIPTION,
    rs.ADDRESS1,
    rs.ADDRESS2,
    rs.ACTIVE_INDICATOR,
    site_country.COUNTRY_EN,
    site_country.LANGUAGE,
    site_country.CURRENCY_NAME,
    NULL AS POSTAL_ZONE,
    rs.REGION,
    rs.CITY
FROM
  deds.dbo.retailer_site rs
INNER JOIN deds.dbo.country site_country ON rs.COUNTRY_CODE = site_country.COUNTRY_CODE
INNER JOIN deds.dbo.retailer retailer ON rs.RETAILER_CODE = retailer.RETAILER_CODE
INNER JOIN deds.dbo.retailer_type rt ON retailer.RETAILER_TYPE_CODE = rt.RETAILER_TYPE_CODE
LEFT JOIN deds.dbo.retailer_headquarters hq ON retailer.RETAILER_CODEMR = hq.RETAILER_CODEMR
INNER JOIN deds.dbo.retailer_segment rsm ON hq.SEGMENT_CODE = rsm.SEGMENT_CODE
LEFT JOIN deds.dbo.country hq_country ON hq.COUNTRY_CODE = hq_country.COUNTRY_CODE;


INSERT INTO
  dw.dbo.dim_return_reason (
    RETURN_REASON_CODE,
    RETURN_DESCRIPTION_EN
  )
SELECT
    RETURN_REASON_CODE,
    RETURN_DESCRIPTION_EN
FROM
  deds.dbo.return_reason;


INSERT INTO
  dw.dbo.dim_sales_branch (
    SALES_BRANCH_CODE,
    ADDRESS1,
    ADDRESS2,
    CITY,
    REGION,
    COUNTRY_NAME,
    COUNTRY_LANGUAGE,
    COUNTRY_CURRENCY_NAME
  )
SELECT
    SALES_BRANCH_CODE,
    ADDRESS1,
    ADDRESS2,
    CITY,
    REGION,
    country.COUNTRY_EN,
    country.LANGUAGE,
    country.CURRENCY_NAME
FROM
  deds.dbo.sales_branch sb
INNER JOIN deds.dbo.country country ON sb.COUNTRY_CODE = country.COUNTRY_CODE;


INSERT INTO dw.dbo.dim_sales_staff (
    SALES_STAFF_CODE,
    FIRST_NAME,
    LAST_NAME,
    POSITION_EN,
    WORK_PHONE,
    EXTENSION,
    FAX,
    EMAIL,
    YEAR_HIRED,
    MONTH_HIRED,
    WEEK_HIRED,
    WEEKDAY_HIRED,
    DAY_HIRED,
    MANAGER_CODE,
    SALES_BRANCH_CODE,
    BRANCH_ADDRESS1,
    BRANCH_ADDRESS2,
    BRANCH_CITY,
    BRANCH_REGION,
    BRANCH_COUNTRY_CODE,
    BRANCH_COUNTRY_NAME,
    BRANCH_COUNTRY_LANGUAGE,
    BRANCH_COUNTRY_CURRENCY_NAME
  )
SELECT
    ss.SALES_STAFF_CODE,
    ss.FIRST_NAME,
    ss.LAST_NAME,
    ss.POSITION_EN,
    ss.WORK_PHONE,
    ss.EXTENSION,
    ss.FAX,
    ss.EMAIL,
    YEAR(CAST(CAST(DATE_HIRED AS VARCHAR(20)) AS DATE)) AS YEAR_HIRED,
    MONTH(CAST(CAST(DATE_HIRED AS VARCHAR(20)) AS DATE)) AS MONTH_HIRED,
    DATEPART(WEEK, CAST(CAST(DATE_HIRED AS VARCHAR(20)) AS DATE)) AS WEEK_HIRED,
 	DATEPART(WEEKDAY, CAST(CAST(DATE_HIRED AS VARCHAR(20)) AS DATE)) AS WEEKDAY_HIRED,
    DAY(CAST(CAST(DATE_HIRED AS VARCHAR(20)) AS DATE)) AS DAY_HIRED,
    ss.MANAGER_CODE,
    ss.SALES_BRANCH_CODE,
    sb.ADDRESS1,
    sb.ADDRESS2,
    sb.CITY,
    sb.REGION,
    country.COUNTRY_CODE,
    country.COUNTRY_EN,
    country.LANGUAGE,
    country.CURRENCY_NAME
FROM
  deds.dbo.sales_staff ss
INNER JOIN deds.dbo.sales_branch sb ON sb.SALES_BRANCH_CODE = ss.SALES_BRANCH_CODE
INNER JOIN deds.dbo.country country ON sb.COUNTRY_CODE = country.COUNTRY_CODE;


INSERT INTO
  dw.dbo.dim_satisfaction_type (
    SATISFACTION_TYPE_CODE,
    SATISFACTION_TYPE_DESCRIPTION
  )
SELECT
    SATISFACTION_TYPE_CODE,
    SATISFACTION_TYPE_DESCRIPTION
FROM
  deds.dbo.satisfaction_type;


INSERT INTO dw.dbo.dim_time (
	TIME_ID,
	YEAR,
	MONTH,
	DATE,
	WEEKDAY
)
SELECT DISTINCT
	CAST(CONVERT(VARCHAR(8), CAST(CONVERT(VARCHAR(MAX), ORDER_DATE) AS DATE), 112) AS INT) AS TIME_ID,
	YEAR(CAST(CONVERT(VARCHAR(MAX), ORDER_DATE) AS DATE)) AS YEAR,
	MONTH(CAST(CONVERT(VARCHAR(MAX), ORDER_DATE) AS DATE)) AS MONTH,
	DAY(CAST(CONVERT(VARCHAR(MAX), ORDER_DATE) AS DATE)) AS DATE,
	DATEPART(WEEKDAY, CAST(CONVERT(VARCHAR(MAX), ORDER_DATE) AS DATE)) AS WEEKDAY
FROM deds.dbo.order_header;


INSERT INTO dw.dbo.dim_time (
	TIME_ID,
	YEAR,
	MONTH,
	DATE,
	WEEKDAY
)
SELECT DISTINCT
	CAST(CONVERT(VARCHAR(8), CAST(CONCAT(YEAR, '-', RIGHT('0' + CAST(MONTH AS VARCHAR), 2), '-01') AS DATE), 112) AS INT) AS TIME_ID,
	YEAR,
	MONTH,
	1 AS DATE,
	DATEPART(WEEKDAY, CAST(CONCAT(YEAR, '-', RIGHT('0' + CAST(MONTH AS VARCHAR), 2), '-01') AS DATE)) AS WEEKDAY
FROM deds.dbo.product_forecast;


INSERT INTO dw.dbo.dim_time (
	TIME_ID,
	YEAR,
	MONTH,
	DATE,
	WEEKDAY
)
SELECT DISTINCT
	CAST(CONVERT(VARCHAR(8), CAST(CONCAT(INVENTORY_YEAR, '-', RIGHT('0' + CAST(INVENTORY_MONTH AS VARCHAR), 2), '-01') AS DATE), 112) AS INT) AS TIME_ID,
	INVENTORY_YEAR,
	INVENTORY_MONTH,
	1 AS DATE,
	DATEPART(WEEKDAY, CAST(CONCAT(INVENTORY_YEAR, '-', RIGHT('0' + CAST(INVENTORY_MONTH AS VARCHAR), 2), '-01') AS DATE)) AS WEEKDAY
FROM deds.dbo.inventory_levels;


INSERT INTO dw.dbo.dim_time (
	TIME_ID,
	YEAR,
	MONTH,
	DATE,
	WEEKDAY
)
SELECT DISTINCT
	CAST(CONVERT(VARCHAR(8), CAST(CONVERT(VARCHAR(MAX), RETURN_DATE) AS DATE), 112) AS INT) AS TIME_ID,
	YEAR(CAST(CONVERT(VARCHAR(MAX), RETURN_DATE) AS DATE)) AS YEAR,
	MONTH(CAST(CONVERT(VARCHAR(MAX), RETURN_DATE) AS DATE)) AS MONTH,
	DAY(CAST(CONVERT(VARCHAR(MAX), RETURN_DATE) AS DATE)) AS DATE,
	DATEPART(WEEKDAY, CAST(CONVERT(VARCHAR(MAX), RETURN_DATE) AS DATE)) AS WEEKDAY
FROM deds.dbo.returned_item;


INSERT INTO dw.dbo.dim_time (
	TIME_ID,
	YEAR,
	MONTH,
	DATE,
	WEEKDAY
)
SELECT DISTINCT
	CAST(CONVERT(VARCHAR(8), CAST(CONCAT(YEAR, '-01-01') AS DATE), 112) AS INT) AS TIME_ID,
	YEAR,
	1 AS MONTH,
	1 AS DATE,
	DATEPART(WEEKDAY, CAST(CONCAT(YEAR, '-01-01') AS DATE)) AS WEEKDAY
FROM deds.dbo.training;

INSERT INTO dw.dbo.dim_time (
	TIME_ID,
	YEAR,
	MONTH,
	DATE,
	WEEKDAY
)
SELECT DISTINCT
	CAST(CONVERT(VARCHAR(8), CAST(CONCAT(YEAR, '-01-01') AS DATE), 112) AS INT) AS TIME_ID,
	YEAR,
	1 AS MONTH,
	1 AS DATE,
	DATEPART(WEEKDAY, CAST(CONCAT(YEAR, '-01-01') AS DATE)) AS WEEKDAY
FROM deds.dbo.satisfaction;

WITH CTE AS (
  SELECT *,
    ROW_NUMBER() OVER (
      PARTITION BY TIME_ID
      ORDER BY (SELECT NULL)
    ) AS rn
  FROM dw.dbo.dim_time
)
DELETE FROM CTE
WHERE rn > 1;

INSERT INTO dw.dbo.fact_inventory_levels (
	INVENTORY_TIME_ID,
	PRODUCT_NUMBER,
	INVENTORY_COUNT
)
SELECT
	dt.TIME_ID,
	il.PRODUCT_NUMBER,
	il.INVENTORY_COUNT
FROM deds.dbo.inventory_levels il
JOIN dw.dbo.dim_time dt
	ON dt.YEAR = il.INVENTORY_YEAR
	AND dt.MONTH = il.INVENTORY_MONTH
	AND dt.DATE = 1;


INSERT INTO dw.dbo.fact_product_forecasts (
	TIME_ID,
	PRODUCT_NUMBER,
	EXPECTED_VOLUME
)
SELECT
	dt.TIME_ID,
	pf.PRODUCT_NUMBER,
	pf.EXPECTED_VOLUME
FROM deds.dbo.product_forecast pf
JOIN dw.dbo.dim_time dt
	ON dt.YEAR = pf.YEAR
	AND dt.MONTH = pf.MONTH
	AND dt.DATE = 1;


INSERT INTO dw.dbo.fact_returns (
	RETURN_TIME_ID,
	RETURN_CODE,
	ORDER_DETAIL_CODE,
	RETURN_REASON_CODE,
	RETURN_QUANTITY
)
SELECT
	CAST(CONVERT(VARCHAR(8), CAST(CONVERT(VARCHAR(MAX), RETURN_DATE) AS DATETIME), 112) AS INT) AS TIME_ID,
	RETURN_CODE,
	ORDER_DETAIL_CODE,
	RETURN_REASON_CODE,
	RETURN_QUANTITY
FROM deds.dbo.returned_item;


INSERT INTO dw.dbo.fact_trainings (
	TIME_ID,
	SALES_STAFF_CODE,
	COURSE_CODE
)
SELECT
	dt.TIME_ID,
	t.SALES_STAFF_CODE,
	t.COURSE_CODE
FROM deds.dbo.training t
JOIN dw.dbo.dim_time dt
	ON dt.YEAR = t.YEAR
	AND dt.MONTH = 1
	AND dt.DATE = 1;


INSERT INTO dw.dbo.fact_satisfaction (
	TIME_ID,
	SALES_STAFF_CODE,
	SATISFACTION_TYPE_CODE
)
SELECT
	dt.TIME_ID,
	s.SALES_STAFF_CODE,
	s.SATISFACTION_TYPE_CODE
FROM deds.dbo.satisfaction s
JOIN dw.dbo.dim_time dt
	ON dt.YEAR = s.YEAR
	AND dt.MONTH = 1
	AND dt.DATE = 1;


INSERT INTO dw.dbo.fact_order (
	ORDER_DETAIL_CODE,
	ORDER_NUMBER,
	RETAILER_SITE_CODE,
	RETAILER_CONTACT_CODE,
	SALES_STAFF_CODE,
	SALES_BRANCH_CODE,
	ORDER_TIME,
	ORDER_METHOD_CODE,
	PRODUCT_NUMBER,
	QUANTITY,
	UNIT_COST,
	UNIT_PRICE,
	UNIT_SALE_PRICE,
	TOTAL_SALE,
	DISCOUNT_PERCENTAGE,
	GROSS_MARGIN
)
SELECT
	od.ORDER_DETAIL_CODE,
	od.ORDER_NUMBER,
	oh.RETAILER_SITE_CODE,
	oh.RETAILER_CONTACT_CODE,
	oh.SALES_STAFF_CODE,
	oh.SALES_BRANCH_CODE,
	dt.TIME_ID,
	oh.ORDER_METHOD_CODE,
	od.PRODUCT_NUMBER,
	od.QUANTITY,
	od.UNIT_COST,
	od.UNIT_PRICE,
	od.UNIT_SALE_PRICE,
	od.QUANTITY * od.UNIT_SALE_PRICE,
	(od.UNIT_PRICE - od.UNIT_SALE_PRICE) / od.UNIT_PRICE,
	od.UNIT_SALE_PRICE - od.UNIT_COST
FROM deds.dbo.order_details od
INNER JOIN deds.dbo.order_header oh ON od.ORDER_NUMBER = oh.ORDER_NUMBER
INNER JOIN (
  SELECT TIME_ID, MIN(TIME_ID) AS SINGLE_TIME_ID
  FROM dw.dbo.dim_time
  GROUP BY TIME_ID
) dt ON dt.TIME_ID = CAST(CONVERT(VARCHAR(8), CAST(CAST(oh.ORDER_DATE AS VARCHAR) AS DATE), 112) AS INT);